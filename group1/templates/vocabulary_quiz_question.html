{% extends "quiz_frame.html" %}
{% block quiz_content %}
<style>
    /* Using shared styles for consistency */
    .option-btn {
        background-color: #23232b;
        border: 1.5px solid #4B5563;
        color: #e0e0e0;
        border-radius: 0.7rem;
        font-size: 1.1rem;
        font-weight: 600;
        padding: 1.1rem 1.2rem;
        margin-bottom: 0.5rem;
        text-align: left;
        transition: all 0.2s;
        cursor: pointer;
    }
    .option-btn:not(:disabled):hover {
        border-color: #a78bfa;
        color: #fff;
        box-shadow: 0 0 0 2px #7c5cff33;
    }
    .option-btn.selected {
        background-color: #7c5cff;
        border-color: #a78bfa;
        color: #fff;
        box-shadow: 0 0 0 2px #7c5cff55;
    }
    .option-btn.correct {
        background-color: #10B981;
        border-color: #34D399;
        color: #fff;
        animation: pop-correct 0.25s;
    }
    .option-btn.incorrect {
        background-color: #EF4444;
        border-color: #F87171;
        color: #fff;
        animation: shake-wrong 0.25s;
    }
    .question-text {
        font-size: 1.2rem;
        color: #fff;
        line-height: 1.6;
    }
    #submit-btn, #next-btn {
        outline: none !important;
        box-shadow: none !important;
    }
    #feedback {
        animation: fadeIn 0.4s;
    }
    @keyframes pop-correct {
        0% { transform: scale(1); } 60% { transform: scale(1.08); } 100% { transform: scale(1); }
    }
    @keyframes shake-wrong {
        0% { transform: translateX(0); } 20% { transform: translateX(-6px); } 40% { transform: translateX(6px); } 60% { transform: translateX(-4px); } 80% { transform: translateX(4px); } 100% { transform: translateX(0); }
    }
    @keyframes fadeIn {
        from { opacity: 0; } to { opacity: 1; }
    }
</style>

<!-- Question Text -->
<div style="margin-bottom: 2rem;">
    <p class="question-text">{{ question.text_or_prompt|safe }}</p>
</div>

<!-- Form for answer submission -->
<form method="post" id="quiz-form">
    {% csrf_token %}
    
    <!-- Answer Options -->
    <div id="options-container" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
        {% for choice in choices %}
            <label class="option-btn start-btn" data-choice-id="{{ choice.id }}" tabindex="0" aria-pressed="false">
                <input type="radio" name="user_answer" value="{{ choice.id }}" style="display: none;">
                {{ choice.text }}
            </label>
        {% endfor %}
    </div>
    
    <!-- Action Buttons -->
    <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        {% if not show_feedback %}
            <button type="submit" name="submit_answer" id="submit-btn" class="start-btn" style="font-size: 1rem; padding: 0.8rem 2.2rem; background: #7c5cff; color: #fff; cursor: pointer;" disabled>Submit Answer</button>
        {% else %}
            <button type="submit" name="next_question" id="next-btn" class="start-btn" style="font-size: 1rem; padding: 0.8rem 2.2rem; background: #7c5cff; color: #fff; cursor: pointer;">Next Question</button>
        {% endif %}
    </div>
</form>

{{ js_data|json_script:"js-data" }}

<!-- Feedback -->
{% if show_feedback %}
<div id="feedback" style="margin-top: 1.5rem;">
    {% if js_data.is_correct %}
        <span style="color: #4caf50; font-weight: 600;">Correct! ðŸŽ‰</span>
    {% else %}
        <span style="color: #ff5252; font-weight: 600;">Incorrect.</span>
        <span style="color: #b0b0b0;"> Correct answer: <b>{{ correct_choice.text }}</b></span>
    {% endif %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jsData = JSON.parse(document.getElementById('js-data').textContent);
    const showFeedback = jsData.show_feedback;
    const isCorrect = jsData.is_correct;
    const correctChoiceId = jsData.correct_choice_id;
    const userAnswerId = jsData.user_answer_id;

    const optionsContainer = document.getElementById('options-container');
    const submitBtn = document.getElementById('submit-btn');
    let selectedOption = null;

    if (showFeedback) {
        optionsContainer.querySelectorAll('.option-btn').forEach(btn => {
            btn.style.pointerEvents = 'none';
            const choiceId = btn.getAttribute('data-choice-id');
            
            if (choiceId == userAnswerId) {
                btn.classList.add(isCorrect ? 'correct' : 'incorrect');
                btn.classList.add('selected');
            }
            if (choiceId == correctChoiceId) {
                btn.classList.add('correct');
            }
        });
        return;
    }

    optionsContainer.addEventListener('click', function(e) {
        const label = e.target.closest('.option-btn');
        if (!label) return;
        
        if (selectedOption) {
            selectedOption.classList.remove('selected');
            selectedOption.setAttribute('aria-pressed', 'false');
        }
        
        selectedOption = label;
        selectedOption.classList.add('selected');
        selectedOption.setAttribute('aria-pressed', 'true');
        
        const input = label.querySelector('input[type="radio"]');
        if (input) input.checked = true;
        
        if (submitBtn) submitBtn.disabled = false;
    });

    optionsContainer.addEventListener('keydown', function(e) {
        if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('option-btn')) {
            e.preventDefault();
            e.target.click();
        }
    });
});
</script>
{% endblock %}
