{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ reading.title }} - {{ reading.difficulty }} Listening Test</title>
  <link rel="stylesheet" href="{% static 'group4/style/style_quiz.css' %}">
</head>
<body>
  <!-- Ù†ÙˆØ§Ø± Ø²Ø±Ø¯ Ø±Ù†Ú¯ Ø¯Ø± Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ -->
  <header class="yellow-bar">
    <h1>{{ reading.title }} â€“ {{ reading.difficulty }} English Listening Test</h1>
  </header>
  

<!-- Timer/Accent/Loading Container - Single position for all states -->
<div id="timer-container" class="test-section">
  <!-- Accent Selection State -->
  <div id="accent-selection">
    <h2>Ù„Ù‡Ø¬Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</h2>
    <div class="accent-buttons-container">
      <button class="accent-btn" data-accent="us">
        ğŸ‡ºğŸ‡¸ American
      </button>
      <button class="accent-btn" data-accent="uk">
        ğŸ‡¬ğŸ‡§ British
      </button>
    </div>
  </div>
  
  <!-- Loading State -->
  <div id="loading-state" style="display: none;">
    <h2>Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®ØªÙ† ØµÙˆØª... Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯</h2>
    <div id="timer">Loading...</div>
  </div>
  
  <!-- Start State -->
  <div id="start-state" style="display: none;">
    <h2>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯</h2>
    <div id="timer">Loading...</div>
    <button id="startButton">Ø´Ø±ÙˆØ¹</button>
  </div>
</div>


  <div class="test-container" id = "container-section" style="display:none;">
    <!-- ØªØµÙˆÛŒØ± Ø¢Ø²Ù…ÙˆÙ† -->
    <header>
      <img src="{% if reading.category.image_path %}{{ reading.category.image_path }}{% else %}{% static 'group4/images/base/default.png' %}{% endif %}" alt="{{ reading.title }}" class="test-image">
    </header>

    <div class="test-description">
      <p>{{ reading.description }}</p>
    </div>
    
    <!-- Ø¨Ø®Ø´ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ -->
    <div class="test-section">
      <audio controls id="audio-player">
        <source id="audio-source" src="" type="audio/mp3">
        Your browser does not support the audio element.
      </audio>
      <div id="audio-loading" style="display: none;">
        <p>Generating audio... Please wait.</p>
      </div>
    </div>
    
    <!-- Ø¨Ø®Ø´ Ø³ÙˆØ§Ù„Ø§Øª -->
    <div class="test-section" id="questions-section" style="display: block;">
      <div class="dropdown-content">
        <form>
          {% for question in questions %}
            <div class="question-item" data-question-id="{{ question.id }}">
              {% if question.question_type == 'multiple_choice' %}
                <p>{{ forloop.counter }}. {{ question.question_text }}
                  <span class="dropdown-container">
                    <select id="question{{ question.id }}">
                      <option value=""></option>
                      {% for option in question.options.all %}
                        <option value="{{ option.option_text }}">{{ option.option_text }}</option>
                      {% endfor %}
                    </select>
                  </span>
                </p>
              {% elif question.question_type == 'fill_blank' %}
                <p>{{ forloop.counter }}. {{ question.question_text }}
                  <input type="text" id="question{{ question.id }}" placeholder="Your answer">
                </p>
              {% elif question.question_type == 'true_false' %}
                <p>{{ forloop.counter }}. {{ question.question_text }}
                  <span class="dropdown-container">
                    <select id="question{{ question.id }}">
                      <option value=""></option>
                      <option value="True">True</option>
                      <option value="False">False</option>
                    </select>
                  </span>
                </p>
              {% elif question.question_type == 'short_answer' %}
                <p>{{ forloop.counter }}. {{ question.question_text }}
                  <input type="text" id="question{{ question.id }}" placeholder="Your answer">
                </p>
              {% endif %}
              <br>
            </div>
          {% endfor %}

          <button type="submit" id="myButton">Check Answers</button>
        </form>
      </div>
    </div>
    
    <!-- Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ -->
    <div class="test-section" id="results-box" style="display: none;">
      <div class="dropdown-content">
        <p><strong>Results</strong></p>
        <p>Correct Answers âœ”: <span id="correct-answers">0</span></p>
        <p>Incorrect AnswersâŒ: <span id="incorrect-answers">0</span></p>
        <br>
        <button id="backToHomeBtn" onclick="window.location.href='/group4/'">
          Back to Home
        </button>
      </div>  
    </div>

    <!-- Ø¨Ø®Ø´ Ø¬Ù…Ù„Ø§Øª ØµØ­ÛŒØ­ Ùˆ ØºÙ„Ø· -->
    <div class="test-section" id="results-sentences" style="display: none;">
      <div class="dropdown-content">
        <!-- Ù†ØªØ§ÛŒØ¬ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ ØµØ­ÛŒØ­ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ÙˆØ§Ù„ -->
        {% for question in questions %}
          <div id="result-{{ question.id }}"></div>
        {% endfor %}
      </div> 
    </div>

    <!-- Ø¨Ø®Ø´ Transcript (Ù¾Ù†Ù‡Ø§Ù† Ø§Ø³Øª) -->
    <div class="test-section" id="transcript-section" style="display: none;">
       <button class="dropdown-btn">Transcript</button>
      <div class="dropdown-content" style="display: none;">
        <div class="transcript-content">
          {{ reading.content|linebreaks }}
        </div>
      </div>
    </div>

  </div>

  <!-- Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø¨Ø®Ø´â€ŒÙ‡Ø§ -->
<script>
// Global variables
const readingId = {{ reading.id }};
const questions = [
  {% for question in questions %}
  {
    id: {{ question.id }},
    type: "{{ question.question_type }}",
    correctAnswer: "{% if question.question_type == 'multiple_choice' %}{% for option in question.options.all %}{% if option.is_correct %}{{ option.option_text }}{% endif %}{% endfor %}{% else %}{{ question.correct_answer }}{% endif %}"
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

let startButton = document.getElementById("startButton");
let timerContainer = document.getElementById("timer-container");

let timeLeft;
let timerInterval;
let selectedAccent = null;

// Handle accent selection
document.addEventListener('DOMContentLoaded', function() {
    const accentButtons = document.querySelectorAll('.accent-btn');
    
    accentButtons.forEach(button => {
        button.addEventListener('click', function() {
            selectedAccent = this.dataset.accent;
            
            // Update button styles
            accentButtons.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Highlight selected button
            this.classList.add('selected');
            
            // Transition to loading state
            document.getElementById('accent-selection').style.display = 'none';
            document.getElementById('loading-state').style.display = 'block';
            
            // Generate audio
            generateAudio();
        });
    });
});

// TTS Audio generation function
async function generateAudio() {
    if (!selectedAccent) {
        console.error('No accent selected');
        return;
    }
    
    try {
        const audioSource = document.getElementById('audio-source');
        const audioPlayer = document.getElementById('audio-player');
        
        // Map accent to voice
        const voiceMap = {
            'us': 'en-US-AriaNeural',
            'uk': 'en-GB-SoniaNeural'
        };
        
        console.log('Selected accent:', selectedAccent);
        console.log('Voice to use:', voiceMap[selectedAccent]);
        
        const response = await fetch("{% url 'group4:generate_audio' reading.id %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                voice: voiceMap[selectedAccent]
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Received audio data:', data);
            console.log('Audio duration:', data.duration);
            console.log('Timestamps length:', data.timestamps?.length);
            
            audioSource.src = data.audio_url;
            audioPlayer.load();
            
            // Set timer based on audio duration (3x the audio length)
            if (data.duration) {
                timeLeft = Math.ceil(data.duration * 3); // 3 times audio duration
                console.log('Timer set to:', timeLeft, 'seconds');
                updateTimerDisplay();
            } else {
                console.warn('No duration provided, using fallback');
                // Fallback to default 4 minutes if no duration provided
                timeLeft = 240;
                updateTimerDisplay();
            }
            
            // Transition to start state
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('start-state').style.display = 'block';
        } else {
            console.error('Failed to generate audio');
            // Show error in loading state
            document.querySelector('#loading-state h2').innerHTML = 'Failed to generate audio. Please refresh the page.';
            // Fallback timer if audio generation fails
            timeLeft = 240;
            updateTimerDisplay();
            // Still show start button even if audio generation fails
            setTimeout(() => {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('start-state').style.display = 'block';
            }, 2000);
        }
    } catch (error) {
        console.error('Error generating audio:', error);
        // Show error in loading state
        document.querySelector('#loading-state h2').innerHTML = 'Error generating audio. Please refresh the page.';
        // Fallback timer if audio generation fails
        timeLeft = 240;
        updateTimerDisplay();
        // Still show start button even if there's an error
        setTimeout(() => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('start-state').style.display = 'block';
        }, 2000);
    }
}

// Update timer display
function updateTimerDisplay() {
    let minutes = Math.floor(timeLeft / 60);
    let seconds = timeLeft % 60;
    const timeText = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
    
    // Update the timer in start state
    const startStateTimer = document.querySelector('#start-state #timer');
    if (startStateTimer) {
        startStateTimer.textContent = timeText;
    }
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Ø´Ø±ÙˆØ¹ ØªØ§ÛŒÙ…Ø±
startButton.addEventListener("click", function() {
    // Hide the entire timer container and show quiz
    timerContainer.style.display = "none";
    document.getElementById("container-section").style.display = "block";
    
    // Get the current timer text from the start state
    const startStateTimer = document.querySelector('#start-state #timer');
    const currentTimerText = startStateTimer ? startStateTimer.textContent : "04:00";
    
    // Create and position the small timer in corner
    const smallTimer = document.createElement('div');
    smallTimer.id = 'small-timer';
    smallTimer.className = 'small-timer';
    smallTimer.textContent = currentTimerText;
    smallTimer.style.display = 'block'; // Ensure visibility
    smallTimer.style.position = 'fixed';
    smallTimer.style.top = '20px';
    smallTimer.style.left = '20px';
    smallTimer.style.zIndex = '1000';
    document.body.appendChild(smallTimer);
    
    // Start the timer
    timerInterval = setInterval(function() {
        timeLeft--;
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        const timeText = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        smallTimer.textContent = timeText;

        if (timeLeft === 0) {
            clearInterval(timerInterval);
            smallTimer.style.display = "none";
            document.getElementById("myButton").click();
        }
    }, 1000);
});

// Submit answers
document.querySelector('button[type="submit"]').addEventListener('click', function(event) {
    clearInterval(timerInterval); // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ØªØ§ÛŒÙ…Ø±
    const smallTimer = document.getElementById('small-timer');
    if (smallTimer) {
        smallTimer.style.display = "none";
    }
    event.preventDefault();  // Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

    let allAnswered = true;
    let userAnswers = {};

    // Collect all answers
    questions.forEach(function(question) {
        const userAnswer = document.getElementById(`question${question.id}`).value.trim();
        
        if (userAnswer === '') {
            allAnswered = false;
            return;
        }
        
        userAnswers[question.id] = userAnswer;
    });

    if (!allAnswered) {
        alert('Please answer all questions before submitting.');
        return;
    }

    // Use client-side checking only
    clientSideChecking(userAnswers);
});

// Client-side checking function
function clientSideChecking(userAnswers) {
    let correctCount = 0;
    let incorrectCount = 0;

    // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
    questions.forEach(function(question, index) {
        const userAnswer = userAnswers[question.id];
        const isCorrect = userAnswer.toLowerCase() === question.correctAnswer.toLowerCase();
        
        if (isCorrect) {
            correctCount++;
        } else {
            incorrectCount++;
        }

        // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ù‡Ø± Ø³ÙˆØ§Ù„
        document.getElementById(`result-${question.id}`).innerHTML = `
            <strong>Question ${index + 1}: ${isCorrect ? 'âœ”' : 'âŒ'} </strong><br>
            Your Choice: ${userAnswer}<br>
            Correct Answer: ${question.correctAnswer}<br><br>
        `;
    });

    // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ú©Ù„ÛŒ
    document.getElementById('correct-answers').textContent = correctCount;
    document.getElementById('incorrect-answers').textContent = incorrectCount;

    // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø®Ø´ Ù†ØªØ§ÛŒØ¬ Ùˆ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ø³ÙˆØ§Ù„Ø§Øª
    document.getElementById('results-sentences').style.display = 'block';
    document.getElementById('results-box').style.display = 'block';
    document.getElementById('transcript-section').style.display = 'block';
    document.getElementById('questions-section').style.display = 'none';
}

// Ø¨Ø§Ø² Ùˆ Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Transcript
document.querySelector('.dropdown-btn').addEventListener('click', function() {
    const transcriptSection = this.nextElementSibling;
    if (transcriptSection.style.display === 'none' || transcriptSection.style.display === '') {
        transcriptSection.style.display = 'block';  // Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† Transcript
    } else {
        transcriptSection.style.display = 'none';  // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù…ØªÙ† Transcript
    }
});

</script>


</body>
</html>
